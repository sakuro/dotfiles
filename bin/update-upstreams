#!/bin/zsh

if [[ $# = 0 ]]; then
  echo "Usage: update-upstreams REPOSITORIES"
  exit 1
fi

for repo in $*; do
  [[ -d $repo/.git ]] || {
    echo "$(print -D $repo) is not a git directory, skipping"
    continue
  }
  (
    cd $repo
    git remote show | grep upstream >/dev/null || {
      echo "$(print -D $repo) does not have an upstream, skipping"
      exit 0
    }
    echo "=== $(print -D $repo) ==="
    git fetch upstream
    if git diff-index --quiet HEAD; then
      default_branch=$(gh repo view --json defaultBranchRef --jq .defaultBranchRef.name)
      git rebase upstream/$default_branch
      if git remote show | grep origin >/dev/null; then
        git push origin
      fi
    else
      echo "There are uncommitted change(s), skipping rebase and push"
    fi
  )
done
