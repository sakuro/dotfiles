#!/bin/zsh

set -eu

[[ $# = 1 ]] || {
  echo "Usage: $0:t GEMSPEC"
  echo ""
  echo "Run by specifing '-e $0:t' when invoking 'bundle gem'"
  exit 1
}

# Use lowest version of ruby
eval "$(mise activate $SHELL:t)"
ruby_lowest="$(mise ls -J ruby | jq -r '.[]|.version' |sort -V |head -n 1 | sed 's/\.[0-9][0-9]*$//')"
mise_ruby="ruby@$ruby_lowest"
eval "$(mise env $mise_ruby)"

gem_name="${1:t:r}"

github_user="${USER}"
repo_url="https://github.com/${github_user}/${gem_name}"

ruby_version="$(ruby -e "puts RUBY_VERSION" | sed 's/\.[0-9][0-9]*$//')"

sed -i \
  -e '/allowed_push_host/d' \
  -e '/required_ruby_version = /s/".*"/">= '${ruby_version}'"/' \
  -e '/spec\.homepage = /s,".*","'${repo_url}'",' \
  -e '/spec\.summary = /s/".*"/"'${gem_name}'"/' \
  -e '/spec\.description = /s/".*"/"'${gem_name}'"/' \
  -e '/source_code_uri/s/= ".*"/= "#{spec.homepage}.git"/' \
  -e '/changelog_uri/s,= ".*",= "#{spec.homepage}/blob/main/CHANGELOG.md",' \
  "$1"

cd "$gem_name"

# Prepare plain Gemfile
cat <<-EOF > Gemfile
# frozen_string_literal: true

source "https://rubygems.org"

gemspec

group :development, :test do
  gem "irb"
  gem "repl_type_completor"
  gem "rake"
end

group :development do
  # RuboCop
  gem "docquet", github: "sakuro/docquet" # An opionated RuboCop config tool
  gem "rubocop"
  gem "rubocop-performance"
  gem "rubocop-rake"
  gem "rubocop-rspec"

  # YARD
  gem "redcarpet"
  gem "yard", github: "lsegal/yard" # Version with Data.define support
end

group :test do
  # RSpec & SimpleCov
  gem "rspec"
  gem "simplecov"
end
EOF

rm -f "spec/${gem_name}_spec.rb"

bundle
bundle binstubs --all

cat <<-EOF > .rspec
--format progress
--color
--require spec_helper
EOF

cat <<-EOF > .simplecov
# frozen_string_literal: true

SimpleCov.start do
  add_filter "/spec/"
  add_filter "/vendor/"
  add_filter "/examples/"

  minimum_coverage 80.0
  # minimum_coverage_by_file 70

  enable_coverage :branch

  # Coverage formats
  formatter SimpleCov::Formatter::MultiFormatter.new(
    [
      SimpleCov::Formatter::HTMLFormatter, # HTML report in coverage/
      SimpleCov::Formatter::SimpleFormatter # Console output
    ]
  )

  # Merge multiple test runs (useful for parallel testing)
  merge_timeout 3600
end
EOF

cat <<-EOF > .yardopts
--markup markdown
--markup-provider redcarpet
--output-dir docs/api
--readme README.md
--files CHANGELOG.md,LICENSE.txt
--exclude spec/
--exclude vendor/
lib/**/*.rb
EOF


cat <<-EOF >> .gitignore
# Gem should ignore Gemfile.lock
Gemfile.lock

# MCP
/.serena/*
!/.serena/project.yml
/.mcp.json
EOF

cat <<-EOF > mise.toml
[tools]
ruby = "$ruby_version"

[env]
_.path = ["bin", "exe"]
EOF
mise trust

bin/docquet install-config --force

git add .

git commit -m ":computer: bundle gem ${gem_name}"
