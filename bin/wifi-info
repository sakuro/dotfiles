#!/bin/zsh

if [[ $((uname -r; echo 25.0.0) | sort -V | head -n1) = 25.0.0 ]]; then
  iface=$(networksetup -listallhardwareports | sed -n -e '/Wi-Fi/{n;s/Device: //;p;q}')
  ssid=$(ipconfig getsummary en0 | grep -Po '(?<=\bSSID\b : ).*')
else
  ssid=$(system_profiler -json -detailLevel basic SPAirPortDataType | jq -rM '.SPAirPortDataType[0].spairport_airport_interfaces[0].spairport_current_network_information._name')
fi

rssi=$(
  osascript -l JavaScript \
    -e 'ObjC.import("CoreWLAN")' \
    -e 'const wifi = $.CWWiFiClient.sharedWiFiClient.performSelector("interface")' \
    -e 'wifi ? wifi.rssiValue : ""'
)

jq -n --arg ssid "$ssid" --arg rssi "$rssi" '{ssid: $ssid, rssi: ($rssi | tonumber)}'
