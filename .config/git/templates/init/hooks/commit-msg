#!/usr/bin/env zsh

COMMIT_MSG_FILE="$1"
COMMIT_MSG="$(cat $COMMIT_MSG_FILE)"

# Allow messages starting with "fixup!" or "squash!"
if echo "$COMMIT_MSG" | grep -qE "^(fixup|squash)!"; then
  exit 0
fi

# Disallow messages without GitHub emoji
if ! echo "$COMMIT_MSG" | head -n 1 | grep -qE "^:\w+: "; then
  echo "Error: Commit message must start with a GitHub :emoji:"
  exit 1
fi

# Disallow raw emoji sequences, use :emoji: notation
if command -v ruby >/dev/null 2>&1; then
  if ruby -e 'exit(STDIN.read =~ /[\p{Emoji}&&[^[:ascii:]]]/ ? 0 : 1)' < "$COMMIT_MSG_FILE" 2>/dev/null; then
    echo "Error: Commit message contains raw emojis. Use :emoji: notation instead"
    exit 1
  fi
else
  echo "Warning: Ruby not found, skipping emoji check"
fi

exit 0
